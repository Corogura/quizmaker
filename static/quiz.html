<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz Maker - Quiz</title>
</head>

<body class="section">
    <h1>Quiz: <span id="quizTitle"></span></h1>
    <div id="questionSection" class="section">
        <h2>Questions</h2>
        <button onclick="editQuiz()" style="display: none;">Edit Quiz</button>
        <div id="questionsContainer"></div>
    </div>

    <button onclick="goBack()">Back to Quizzes</button>

    <script>
        let currentUserRefreshToken = localStorage.getItem('refresh_token');
        let currentUserJWT = localStorage.getItem('jwt');
        let currentUser = localStorage.getItem('user');
        
        let points = 0;
        let totalQuestions = 0;

        loadQuestions();
        checkOwnership();

        async function checkOwnership() {
            if (currentUserJWT === null) {
                return;
            }
            const response = await fetch(`${window.location.pathname}/owner`, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${currentUserJWT}` }
            });
            if (response.ok) {
                const data = await response.json();
                if (data.is_owner) {
                    document.querySelector('button[onclick="editQuiz()"]').style.display = 'inline';
                }
            }
        }

        async function loadQuestions() {
            const response = await fetch(`${window.location.pathname}/questions`, {
                method: 'GET'
            });

            if (response.ok) {
                const data = await response.json();
                const questions = data.questions;
                const questionsContainer = document.getElementById('questionsContainer');
                questionsContainer.innerHTML = '';
                questions.forEach(question => {
                    const questionDiv = document.createElement('div');
                    const questionText = document.createElement('p');
                    questionText.textContent = question.question_text;
                    questionDiv.appendChild(questionText);
                    question.choices.forEach((choice, index) => {
                        const choiceLabel = document.createElement('label');
                        const choiceInput = document.createElement('input');
                        choiceInput.type = 'radio';
                        choiceInput.name = `question_${question.id}`;
                        choiceInput.value = index;
                        choiceLabel.textContent = choice.choice_text;
                        if (choice.is_correct) {
                            choiceInput.value = 'correct';
                        }
                        choiceLabel.appendChild(choiceInput);
                        questionDiv.appendChild(choiceLabel);
                        questionDiv.appendChild(document.createElement('br'));
                    });
                    const submitButton = document.createElement('button');
                    submitButton.textContent = 'Submit Answer';
                    submitButton.onclick = () => {
                        const selected = document.querySelector(`input[name="question_${question.id}"]:checked`);
                        if (selected) {
                            if (selected.value === 'correct') {
                                alert('Correct!');
                                points++;
                            } else {
                                alert('Incorrect.');
                            }
                            submitButton.disabled = true;
                            updateScore();
                        } else {
                            alert('Please select an answer.');
                        }
                    };
                    questionDiv.appendChild(submitButton);
                    questionsContainer.appendChild(questionDiv);
                    questionsContainer.appendChild(document.createElement('hr'));
                    totalQuestions++;
                })
                const pointsDisplay = document.createElement('p');
                pointsDisplay.id = 'pointsDisplay';
                pointsDisplay.textContent = `Score: ${points}/${totalQuestions}`;
                questionsContainer.appendChild(pointsDisplay);
            } else {
                alert('Error loading questions.');
            }
        }

        async function editQuiz() {
            if (currentUserJWT === null) {
                alert('Please log in first');
                return;
            }
            const existingDiv = document.getElementById('addQuestionDiv');
            if (existingDiv) {
                existingDiv.remove();
                return;
            }
            const addQuestionDiv = document.createElement('div');
            addQuestionDiv.id = 'addQuestionDiv';
            const questionInput = document.createElement('input');
            questionInput.type = 'text';
            questionInput.placeholder = 'Enter question text';
            addQuestionDiv.appendChild(questionInput);
            addQuestionDiv.appendChild(document.createElement('br'));
            for (let i = 0; i < 4; i++) {
                const correctAnswerInput = document.createElement('input');
                correctAnswerInput.type = 'radio';
                correctAnswerInput.name = 'correctAnswer';
                correctAnswerInput.value = i + 1;
                addQuestionDiv.appendChild(correctAnswerInput);
                const choiceInput = document.createElement('input');
                choiceInput.type = 'text';
                choiceInput.name = `choice${i + 1}`;
                choiceInput.placeholder = `Enter choice ${i + 1}`;
                addQuestionDiv.appendChild(choiceInput);
                addQuestionDiv.appendChild(document.createElement('br'));
            }
            const addButton = document.createElement('button');
            addButton.textContent = 'Add Question';
            addButton.onclick = async () => {
                const questionText = questionInput.value;
                const choice1 = addQuestionDiv.querySelector('input[name="choice1"]').value;
                const choice2 = addQuestionDiv.querySelector('input[name="choice2"]').value;
                const choice3 = addQuestionDiv.querySelector('input[name="choice3"]').value;
                const choice4 = addQuestionDiv.querySelector('input[name="choice4"]').value;
                const answerIndex = addQuestionDiv.querySelector('input[name="correctAnswer"]:checked');
                
                if (!questionText || !choice1 || !choice2 || !choice3 || !choice4 || !answerIndex) {
                    alert('Please fill in all fields and select a correct answer');
                    return;
                }
                const response = await fetch(`${window.location.pathname}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentUserJWT}` },
                    body: JSON.stringify({ question: questionText, choice1, choice2, choice3, choice4, answer: parseInt(answerIndex.value, 10) })
                });
                if (response.ok) {
                    alert('Question added successfully');
                    loadQuestions();
                } else {
                    alert(`Error adding question: ${response.statusText}`);
                }
            };
            addQuestionDiv.appendChild(addButton);
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.onclick = () => {
                addQuestionDiv.remove();
            };
            addQuestionDiv.appendChild(cancelButton);
            const questionsContainer = document.getElementById('questionsContainer');
            questionsContainer.prepend(addQuestionDiv);
        }

        function updateScore() {
            const pointsDisplay = document.getElementById('pointsDisplay');
            pointsDisplay.textContent = `Score: ${points}/${totalQuestions}`;
        }

        function goBack() {
            window.location.href = '/';
        }
    </script>
</html>